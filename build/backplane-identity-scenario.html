<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en"><head><title>Echo: Backplane Identity Scenario</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="description" content="Backplane Identity Scenario">
<meta name="generator" content="xml2rfc v1.35 (http://xml.resource.org/)">
<style type='text/css'><!--
        body {
                font-family: verdana, charcoal, helvetica, arial, sans-serif;
                font-size: small; color: #000; background-color: #FFF;
                margin: 2em;
        }
        h1, h2, h3, h4, h5, h6 {
                font-family: helvetica, monaco, "MS Sans Serif", arial, sans-serif;
                font-weight: bold; font-style: normal;
        }
        h1 { color: #900; background-color: transparent; text-align: right; }
        h3 { color: #333; background-color: transparent; }

        td.RFCbug {
                font-size: x-small; text-decoration: none;
                width: 30px; height: 30px; padding-top: 2px;
                text-align: justify; vertical-align: middle;
                background-color: #000;
        }
        td.RFCbug span.RFC {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: bold; color: #666;
        }
        td.RFCbug span.hotText {
                font-family: charcoal, monaco, geneva, "MS Sans Serif", helvetica, verdana, sans-serif;
                font-weight: normal; text-align: center; color: #FFF;
        }

        table.TOCbug { width: 30px; height: 15px; }
        td.TOCbug {
                text-align: center; width: 30px; height: 15px;
                color: #FFF; background-color: #900;
        }
        td.TOCbug a {
                font-family: monaco, charcoal, geneva, "MS Sans Serif", helvetica, sans-serif;
                font-weight: bold; font-size: x-small; text-decoration: none;
                color: #FFF; background-color: transparent;
        }

        td.header {
                font-family: arial, helvetica, sans-serif; font-size: x-small;
                vertical-align: top; width: 33%;
                color: #FFF; background-color: #666;
        }
        td.author { font-weight: bold; font-size: x-small; margin-left: 4em; }
        td.author-text { font-size: x-small; }

        /* info code from SantaKlauss at http://www.madaboutstyle.com/tooltip2.html */
        a.info {
                /* This is the key. */
                position: relative;
                z-index: 24;
                text-decoration: none;
        }
        a.info:hover {
                z-index: 25;
                color: #FFF; background-color: #900;
        }
        a.info span { display: none; }
        a.info:hover span.info {
                /* The span will display just on :hover state. */
                display: block;
                position: absolute;
                font-size: smaller;
                top: 2em; left: -5em; width: 15em;
                padding: 2px; border: 1px solid #333;
                color: #900; background-color: #EEE;
                text-align: left;
        }

        a { font-weight: bold; }
        a:link    { color: #900; background-color: transparent; }
        a:visited { color: #633; background-color: transparent; }
        a:active  { color: #633; background-color: transparent; }

        p { margin-left: 2em; margin-right: 2em; }
        p.copyright { font-size: x-small; }
        p.toc { font-size: small; font-weight: bold; margin-left: 3em; }
        table.toc { margin: 0 0 0 3em; padding: 0; border: 0; vertical-align: text-top; }
        td.toc { font-size: small; font-weight: bold; vertical-align: text-top; }

        ol.text { margin-left: 2em; margin-right: 2em; }
        ul.text { margin-left: 2em; margin-right: 2em; }
        li      { margin-left: 3em; }

        /* RFC-2629 <spanx>s and <artwork>s. */
        em     { font-style: italic; }
        strong { font-weight: bold; }
        dfn    { font-weight: bold; font-style: normal; }
        cite   { font-weight: normal; font-style: normal; }
        tt     { color: #036; }
        tt, pre, pre dfn, pre em, pre cite, pre span {
                font-family: "Courier New", Courier, monospace; font-size: small;
        }
        pre {
                text-align: left; padding: 4px;
                color: #000; background-color: #CCC;
        }
        pre dfn  { color: #900; }
        pre em   { color: #66F; background-color: #FFC; font-weight: normal; }
        pre .key { color: #33C; font-weight: bold; }
        pre .id  { color: #900; }
        pre .str { color: #000; background-color: #CFF; }
        pre .val { color: #066; }
        pre .rep { color: #909; }
        pre .oth { color: #000; background-color: #FCF; }
        pre .err { background-color: #FCC; }

        /* RFC-2629 <texttable>s. */
        table.all, table.full, table.headers, table.none {
                font-size: small; text-align: center; border-width: 2px;
                vertical-align: top; border-collapse: collapse;
        }
        table.all, table.full { border-style: solid; border-color: black; }
        table.headers, table.none { border-style: none; }
        th {
                font-weight: bold; border-color: black;
                border-width: 2px 2px 3px 2px;
        }
        table.all th, table.full th { border-style: solid; }
        table.headers th { border-style: none none solid none; }
        table.none th { border-style: none; }
        table.all td {
                border-style: solid; border-color: #333;
                border-width: 1px 2px;
        }
        table.full td, table.headers td, table.none td { border-style: none; }

        hr { height: 1px; }
        hr.insert {
                width: 80%; border-style: none; border-width: 0;
                color: #CCC; background-color: #CCC;
        }
--></style>
</head>
<body>
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<table summary="layout" width="66%" border="0" cellpadding="0" cellspacing="0"><tr><td><table summary="layout" width="100%" border="0" cellpadding="2" cellspacing="1">
<tr><td class="header">Echo</td><td class="header">Echo</td></tr>
<tr><td class="header">&nbsp;</td><td class="header">November 1, 2010</td></tr>
</table></td></tr></table>
<h1><br />Backplane Identity Scenario</h1>

<h3>Abstract</h3>

<p>This documents specifies an application of Backplane
        to a scenario involving authentication and identity
        information passing.
</p><a name="toc"></a><br /><hr />
<h3>Table of Contents</h3>
<p class="toc">
<a href="#introduction">1.</a>&nbsp;
Introduction<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#anchor1">1.1.</a>&nbsp;
Requirements Language<br />
<a href="#identity.representation">2.</a>&nbsp;
Representation Of Identity Information<br />
<a href="#message.types">3.</a>&nbsp;
Message Types<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#message.type.identity.login">3.1.</a>&nbsp;
identity/login<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#message.type.identity.logout">3.2.</a>&nbsp;
identity/logout<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#message.type.identity.ack">3.3.</a>&nbsp;
identity/ack<br />
<a href="#use.cases">4.</a>&nbsp;
Use Cases<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#use.cases.parts">4.1.</a>&nbsp;
Interacting Parties<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#use.cases.parts.identity.manager">4.1.1.</a>&nbsp;
Identity Manager<br />
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="#use.cases.parts.submission.proxy">4.1.2.</a>&nbsp;
Echo Submission Proxy<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#use.cases.init">4.2.</a>&nbsp;
Backplane Initialization<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#use.cases.1">4.3.</a>&nbsp;
Use case 1: A brand-new user logs in<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#use.cases.2">4.4.</a>&nbsp;
Use case 2: A logged-in user loads the page<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#use.cases.3">4.5.</a>&nbsp;
Use case 3: A logged-in user logs out<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#use.cases.4">4.6.</a>&nbsp;
Use case 4: A third-party
        widget needs to learn the login status of the user after the
        fact<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#use.cases.5">4.7.</a>&nbsp;
Use case 5: A logged-in user
        opens another copy of the same window<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#use.cases.6">4.8.</a>&nbsp;
Use case 6: A user logs in on
        a page where no Echo Stream Client is present<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#use.cases.7">4.9.</a>&nbsp;
Use case 7: A user leaves a
        'like' or reply<br />
<a href="#rfc.references1">5.</a>&nbsp;
References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references1">5.1.</a>&nbsp;
Normative References<br />
&nbsp;&nbsp;&nbsp;&nbsp;<a href="#rfc.references2">5.2.</a>&nbsp;
Informative References<br />
<a href="#rfc.authors">&#167;</a>&nbsp;
Author's Address<br />
</p>
<br clear="all" />

<a name="introduction"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1"></a><h3>1.&nbsp;
Introduction</h3>

<p>While Backplane is a generic framework for message exchange
        between trusted applications in the context of a browser session,
        the Identity Scenario is a specific protocol that facilitates
        authentication and identity transactions between those
        applications.
</p>
<a name="anchor1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.1.1"></a><h3>1.1.&nbsp;
Requirements Language</h3>

<p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
          NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
          "OPTIONAL" in this document are to be interpreted as described
          in <a class='info' href='#RFC2119'>RFC 2119<span> (</span><span class='info'>Bradner, S., &ldquo;Key words for use in RFCs to Indicate Requirement Levels,&rdquo; March&nbsp;1997.</span><span>)</span></a> [RFC2119].
</p>
<a name="identity.representation"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.2"></a><h3>2.&nbsp;
Representation Of Identity Information</h3>

<p>User identity information communicated between Backplane
        parties in this scenario is represented in
        <a class='info' href='#PortableContacts'>Portable Contacts<span> (</span><span class='info'>Smarr, J., &ldquo;Portable Contacts 1.0 Draft C,&rdquo; August&nbsp;2008.</span><span>)</span></a> [PortableContacts] (PoCo)
        format with some restrictions and extensions.
</p>
<p>PoCo data is presented in the <a class='info' href='#RFC4627'>JSON<span> (</span><span class='info'>Crockford, D., &ldquo;The application/json Media Type for JavaScript Object             Notation (JSON),&rdquo; July&nbsp;2006.</span><span>)</span></a> [RFC4627]
        format.
</p>
<p>Since the scenario deals with a single user (the one
        performing identity-related actions in the context of a concrete
        browsing session), PoCo response node MUST contain a single
        "entry" object.
</p>
<p>The "entry" object MUST contain the "accounts" element with at
        least one item. Each of the account items represents an
        identity.
</p>
<p>An identity is represented by "identityUrl" element, which can
        be either a plain <a class='info' href='#RFC1738'>URL<span> (</span><span class='info'>Berners-Lee, T., Masinter, L., and M. McCahill, &ldquo;Uniform Resource Locators (URL),&rdquo; December&nbsp;1994.</span><span>)</span></a> [RFC1738] of user identity,
        or normalized SGN identity <a class='info' href='#RFC3986'>URI<span> (</span><span class='info'>Berners-Lee, T., Fielding, R., and L. Masinter, &ldquo;Uniform Resource Identifiers (URI): Generic Syntax,&rdquo; January&nbsp;2005.</span><span>)</span></a> [RFC3986]
        constructed from domain/userid pair by putting these values
        together: <tt>sgn://&lt;DOMAIN&gt;/?ident=&lt;USERID&gt;</tt>.
        In the latter case SGN identity URI MUST be recognized by
        <a class='info' href='#Google.SGNodeMapper'>Google's SGNodeMapper<span> (</span><span class='info'>Fitzpatrick, B., &ldquo;SocialGraph Node Mapper,&rdquo; 2010.</span><span>)</span></a> [Google.SGNodeMapper].
</p>
<p>Here is an example of a valid PoCo entry that may be
          transferred in a Backplane message:
</p><div style='display: table; width: 0; margin-left: 3em; margin-right: auto'><pre>
{
    "startIndex": 0,
    "itemsPerPage": 1,
    "totalResults": 1,
    "entry": {
        "accounts": [
            {
                "identityUrl" : "http://twitter.com/johndoe",
                "username": "johndoe",
                "emails": [{
                    "value": "username@email.com",
                    "primary": "true"
                }],
                "photos": [{
                    "value": "http://img.twitter.com/johndoe.jpg"
                    "type": "avatar"
                }]
            },
            {
                "identityUrl": "http://example.com/user/johndoe"
            },
            {
                "identityUrl": "sgn://livejournal.com/?ident=johndoe"
            }
        ]
    }
}
</pre></div>
<a name="message.types"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3"></a><h3>3.&nbsp;
Message Types</h3>

<p>Below is a list of Backplane message types employed in this
        scenario.
</p>
<a name="message.type.identity.login"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.1"></a><h3>3.1.&nbsp;
identity/login</h3>

<p>This message is transmitted whenever an application (e.g. an
          Identity Manager) on a Backplane channel authenticates a user
          against an identity provider (e.g. Twitter or Facebook). The
          only party that is allowed to post this message is the one
          that directly facilitated the authentication (login) process
          (e.g. an Identity Connector).
</p>
<p>The payload of the 'identity/login' message is a JSON object
          which contains the following fields:
          </p>
<blockquote class="text"><dl>
<dt>context</dt>
<dd>the URL of the page where the authentication took
              place
</dd>
<dt>identities</dt>
<dd>a PoCo object listing the identities that the user
              has gained by authenticating
</dd>
</dl></blockquote><p>
        
</p>
<p>Note that 'identity/login' messages are incremental, communicating
        addition of the specified identities to the current user session.
</p>
<a name="message.type.identity.logout"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.2"></a><h3>3.2.&nbsp;
identity/logout</h3>

<p>This message is transmitted whenever an application (e.g. an
          Identity Manager) on a Backplane channel logs the user out of
          an identity provider (e.g. Twitter or Facebook). The only
          party that is allowed to post this message is the one that
          directly facilitated the logout process (e.g. an Identity
          Connector).
</p>
<p>The payload of the 'identity/logout' message is a JSON object
          which contains the following fields:
          </p>
<blockquote class="text"><dl>
<dt>context</dt>
<dd>the URL of the page where the logout took place
</dd>
<dt>identities</dt>
<dd>a PoCo object listing the identities that the user
              has dropped with the logout
</dd>
</dl></blockquote><p>
        
</p>
<a name="message.type.identity.ack"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.3.3"></a><h3>3.3.&nbsp;
identity/ack</h3>

<p>This message MAY be transmitted by a Backplane-enabled party
          to notify others that it has processed a recent login or logout
          event (communicated via 'identity/login' or 'identity/logout'
          messages respectively).
</p>
<p>The structure of the message payload is sender-specific.
          Recipients are expected to check the 'source' field of the
          message and parse the payload accordingly. It is beyond this
          document to map sender identifiers to the payload structure.
</p>
<p>To give an example, a server might send the 'identity/ack'
          message to notify related widgets that a user has logged in (the
          server has processed 'identity/login' message sent by another
          party). The corresponding session information could be
          piggybacked into the message payload or the widgets might
          respond to the 'identity/ack' message by issuing a separate
          request to fetch it. The widgets will ignore all broadcast
          'identity/ack' messages except for the one containing the known
          sender id.
</p>
<a name="use.cases"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4"></a><h3>4.&nbsp;
Use Cases</h3>

<p>The following use cases illustrate the process highlighting
        implementation details of the Echo service, but it is important
        to note that Echo is not in any way a 'special' party. Any other
        similar service can employ the Backplane Identity Scenario
        without a need to inform or modify other parties.
</p>
<a name="use.cases.parts"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1"></a><h3>4.1.&nbsp;
Interacting Parties</h3>

<p>The use cases mentioned below make use of the following interacting parties:
          </p>
<ul class="text">
<li>A customer, serving content off http://customer.com.
</li>
<li>An independent Backplane server (running CNAMEd to
              backplane.customer.com), serving the customer's bus.
</li>
<li>
              Widgets on the customer's page:
              
<ul class="text">
<li>Echo Stream Client (ESC)
</li>
<li>Identity Manager (IM)
</li>
<li>Login Status Widget (LSW)
</li>
</ul>
            
</li>
<li>Identity Connector idcon.com, acting as a server-side
              counterpart of the IM.
</li>
<li>Echo server components:
              
<ul class="text">
<li>an API endpoint for Echo widgets on the customer's
                  page (available behind echoapi.customer.com
                  CNAME).
</li>
<li>an API endpoint for server-to-server communication
                  (available as api.aboutecho.com).
</li>
<li>a bus consumer - a server component listening to all
                  messages broadcast on the customer's bus.
</li>
</ul>
            
</li>
<li>
              <a class='info' href='#use.cases.parts.submission.proxy'>Echo Submission Proxy<span> (</span><span class='info'>Echo Submission Proxy</span><span>)</span></a>
            
</li>
</ul><p>
        
</p>
<p>All the parties are configured to use the same Backplane bus
          "customer.com". The configuration includes merely stating the
          Backplane server address and bus identifier for widgets
          (operating in read-only mode). Parties that post data (e.g.
          the Identity Connector) or listen to the entire Backplane bus
          (e.g. the Echo bus consumer) also need to have
          a username/password set up with the Backplane server to
          perform secure HTTPS  requests with basic HTTP
          authentication.
</p>
<a name="use.cases.parts.identity.manager"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1.1"></a><h3>4.1.1.&nbsp;
Identity Manager</h3>

<p>Identity Manager (IM) is an Echo-specific widget that
            allows user to manage their identity. IM is not required to
            be a part of the workflow and is described here just to aid
            in understanding of the use cases.
</p>
<p>
            Once the page loads, Identity Manager fetches a list of
            supported identity providers (e.g. Twitter, Facebook,
            Customer's Own Login System) from its per-domain
            configuration. Each item of the list contains:

            </p>
<ul class="text">
<li>Identity Provider's favicon.
</li>
<li>Identity Provider's name ("Twitter", "Facebook").
</li>
<li>A URL of an Identity Connector that facilitates
                logins/logouts for the Identity Provider in this context
                (e.g. for this customer).
</li>
</ul><p>
          
</p>
<p>This way a customer may mix and match which Identity Connectors are used
            to deal with specific Identity Providers.
</p>
<p>Identity Manager presents the Identity Provider list to the user for selection. Once the user chooses to authenticate against a certain provider, the Identity Manager opens the Identity Connector's URL in a popup passing it the Backplane channel id as a parameter.
</p>
<p>This procedure is not detailed below in the use cases for the sake of brevity; it is referred to only as "the user initiates a login using IM".
</p>
<a name="use.cases.parts.submission.proxy"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.1.2"></a><h3>4.1.2.&nbsp;
Echo Submission Proxy</h3>

<p>Echo servers don't accept insecure data submissions: all
            such requests have to be securely signed and originate from
            a server side. This prevents a widget from submitting data
            directly to Echo APIs (otherwise a secret would be
            exposed).
</p>
<p>In order to circumvent such limitation Echo widgets use
            server counterparts which:
            </p>
<ul class="text">
<li>receive data from the widgets via an ad-hoc protocol;
</li>
<li>perform authorization checks to make sure that the
                current user is indeed allowed to submit the data;
</li>
<li>place the data on the Echo server in a secure
                manner.
</li>
</ul>

<p>These components are called "submission proxies" since they
            pass through data submission requests.
</p>
<p>Echo Submission Proxy (ESP) is the submission proxy for
            Echo Stream Client.
</p>
<a name="use.cases.init"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.2"></a><h3>4.2.&nbsp;
Backplane Initialization</h3>

<p>All use cases below share the following initialization
          sequence, taking place at the very beginning:

          </p>
<ol class="text">
<li>Echo bus consumer connects to the Backplane bus (starts
              polling the Backplane server with GET requests to
              http://backplane.customer.com/v1/bus/customer.com).
</li>
<li>An end user loads a Backplane-enabled page at
              http://customer.com/pages/1.
</li>
<li>Once the page loads, Backplane library checks if there is
              a cookie named 'backplane-channel' set against
              customer.com.
</li>
<li>If the cookie is set, its value is parsed and the library
              gets information about  a channel name associated with bus
              name customer.com. Otherwise the library generates a new
              channel name and records information about the channel
              name and bus name association in the cookie set against
              customer.com domain.
</li>
<li>Backplane library starts asynchronous polling of channel
              http://backplane.customer.com/v1/bus/customer.com/channel/&lt;CHANNEL_NAME&gt;
              with GET requests.
</li>
<li>ESC, IM and LSW all call Backplane library and register
              their callbacks.
</li>
<li>ESC makes a call to http://echoapi.customer.com/v1/users/whoami
              to learn the user's identity, passing the channel id as a parameter.
</li>
</ol><p>
        
</p>
<a name="use.cases.1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.3"></a><h3>4.3.&nbsp;
Use case 1: A brand-new user logs in</h3>

<p>
          </p>
<ol class="text">
<li>The initialization takes place.
</li>
<li>Echo server behind echoapi.customer.com looks up if there is
              an active session object associated with the channel id. Since
              it's a brand new login, there isn't one so the Echo server
              replies to the request with "you are anonymous" response.
</li>
<li>The user initiates a login using IM.
</li>
<li>IM performs the login sequence communicating with idcon.com
              and using the channel id as a unique identifier of the
              session.
</li>
<li>Once the login workflow is complete, idcon.com creates an
              'identity/login' message and posts it to the Backplane channel
              (this is a secure server-to-server call).
</li>
<li>Echo bus consumer receives the 'identity/login' message 
              from the bus and:
              
<ul class="text">
<li>uses the 'context' field to look up a customer by the
                  URL's domain name;
</li>
<li>uses 'identities' object to look up a user account in the
                  customer's namespace;
</li>
<li>creates or retrieves a session for the user account and
                  associates it with the channel id;
</li>
<li>pushes identity/ack backplane message to the channel ID
                  (http://backplane.customer.com/v1/bus/customer.com/channel/&lt;CHANNEL_NAME&gt;)
                  with information about the session
                
</li>
</ul>
            
</li>
<li>Backplane library receives the 'identity/login' 
              and waits for the 'identity/ack' message 
</li>
<li>Backplane library receives the 'identity/ack' message,
              gets the information about the sender from the 'source'
              field. And using particular rules for the specified sender
              get session identifier from the 'payload' field
</li>
<li>Backplane library retrieves information about session
              using session identifier 
              with the help of any proprietary protocol 
</li>
<li>Backplane library
              notifies all interested widgets (ESC, IM, LSW).
</li>
<li>LSW trusts the message without verification and updates its
              display (now shows "Logged in as ...").'
</li>
<li> Backplane library 
              passes it to ESC (as part of subscribers notification process).
</li>
<li>ESC updates visual representation of the echo stream using
              new information about the user.
</li>
</ol><p>
        
</p>
<a name="use.cases.2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.4"></a><h3>4.4.&nbsp;
Use case 2: A logged-in user loads the page</h3>

<p>
          </p>
<ol class="text">
<li>The initialization takes place. Since the user is logged
              in, the Backplane channel id is passed along to the
              'whoami' API endpoint of Echo.
</li>
<li>Echo server looks up a session associated with the
              channel id.
</li>
<li>If the session still exists, the user account information
              is passed back to ESC.
</li>
</ol><p>
        
</p>
<a name="use.cases.3"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.5"></a><h3>4.5.&nbsp;
Use case 3: A logged-in user logs out</h3>

<p>
          </p>
<ol class="text">
<li>The initialization takes place. Since the user is logged
              in, the Backplane channel id is passed along to the
              'whoami' API endpoint of Echo.
</li>
<li>Echo server looks up a session associated with the
              channel id.
</li>
<li>If the session still exists, the user account information
              is passed back to ESC.
</li>
<li>The user initiates a logout using IM.
</li>
<li>IM performs the logout sequence communicating with
              idcon.com and using the channel id as a unique identifier
              of the session.
</li>
<li>Once the logout workflow is complete, idcon.com creates
              an 'identity/logout' message and posts it to the Backplane
              channel (this is a secure server-to-server call).
</li>
<li>Echo bus consumer receives the 'identity/logout' message
              from the bus and:
              
<ul class="text">
<li>uses the 'context' field to look up a customer by the
                  URL's domain name;
</li>
<li>uses 'identities' object to look up a user account in
                  the customer's namespace;
</li>
<li>retrieves the session for the user account and marks
                  corresponding identity (identities) as "logged out".
                
</li>
<li>pushes identity/ack backplane message to the channel ID
                  (http://backplane.customer.com/v1/bus/customer.com/channel/&lt;CHANNEL_NAME&gt;)
                
</li>
</ul>
            
</li>
<li>Backplane library receives the 'identity/logout' message
              and waits for the 'identity/ack' message 
</li>
<li>Backplane library receives the 'identity/ack' message,
              gets the information about the sender from the 'source'
              field. And using particular rules for the specified sender
              get session identifier from the 'payload' field
</li>
<li>Backplane library retrieves information about session
              using session identifier 
              with the help of any proprietary protocol 
</li>
<li>Backplane library
              notifies all interested widgets (ESC, IM, LSW).
</li>
<li>LSW trusts the message without verification and updates
              its display.
</li>
</ol><p>
        
</p>
<a name="use.cases.4"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.6"></a><h3>4.6.&nbsp;
Use case 4: A third-party
        widget needs to learn the login status of the user after the
        fact</h3>

<p>Backplane Identity Scenario is a stateless protocol. There is
          no way to retrieve the current state from Backplane. In order
          to do that a widget or client needs to keep track of Backplane
          events occuring on a channel. Another possibility is to use an
          API of a service which does that (for example, if a widget is
          certain that Echo is on the Backplane channel, the former can
          get user account information from the Echo server
          directly).
</p>
<a name="use.cases.5"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.7"></a><h3>4.7.&nbsp;
Use case 5: A logged-in user
        opens another copy of the same window</h3>

<p>Since the Backplane channel name is stored in the cookie,
          opening a new window without closing the original one is no
          different from <a class='info' href='#use.cases.2'>Use case 2<span> (</span><span class='info'>Use case 2: A logged-in user loads the page</span><span>)</span></a>.
</p>
<a name="use.cases.6"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.8"></a><h3>4.8.&nbsp;
Use case 6: A user logs in on
        a page where no Echo Stream Client is present</h3>

<p>Since Echo uses Backplane channel id which is stored in a
          cookie, the only requirement is that the Backplane library
          executed on the page where login happens. This will ensure
          that Echo will later be able to look up its session object by
          the channel id (Echo bus consumer will catch the
          'identity/login' message and set up the association).
</p>
<a name="use.cases.7"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.4.9"></a><h3>4.9.&nbsp;
Use case 7: A user leaves a
        'like' or reply</h3>

<p>
          </p>
<ol class="text">
<li>The initialization takes place. The channel name is
              either retrieved from the cookie or generated anew. ESC
              learns the user identity (if Echo server is aware of
              one).
</li>
<li>Echo server looks up a session associated with the
              channel id.
</li>
<li>If the session still exists, the user account
              information is passed back to ESC.
</li>
<li>The user clicks 'like' button or submits a
              comment/reply.
</li>
<li>ESC sends the data (using an ad-hoc protocol) to ESP
              running on esp.customer.com. Channel ID value is passed
              along.
</li>
<li>ESP makes a (server-to-server) request to Echo servers
              to check if the Backplane channel ID received from ESC is
              associated with an active session on the Echo side. If no
              Backplane channel was received, ESP checks if anonymous
              posting/liking is allowed.
</li>
<li>ESP then makes a decision (based on Echo server's
              response and established policy) if it is okay to submit
              the data.
</li>
<li>ESP either submits the data and returns an
              acknowledgment to ESC or discards the data and returns
              error.
</li>
</ol><p>
        
</p>
<a name="rfc.references"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<a name="rfc.section.5"></a><h3>5.&nbsp;
References</h3>

<a name="rfc.references1"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>5.1.&nbsp;Normative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="RFC1738">[RFC1738]</a></td>
<td class="author-text">Berners-Lee, T., Masinter, L., and M. McCahill, &ldquo;<a href="http://tools.ietf.org/html/rfc1738">Uniform Resource Locators (URL)</a>,&rdquo; December&nbsp;1994.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC2119">[RFC2119]</a></td>
<td class="author-text"><a href="mailto:sob@harvard.edu">Bradner, S.</a>, &ldquo;<a href="http://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>,&rdquo; March&nbsp;1997.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC3986">[RFC3986]</a></td>
<td class="author-text">Berners-Lee, T., Fielding, R., and L. Masinter, &ldquo;<a href="http://tools.ietf.org/html/rfc3986">Uniform Resource Identifiers (URI): Generic Syntax</a>,&rdquo; January&nbsp;2005.</td></tr>
</table>

<a name="rfc.references2"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>5.2.&nbsp;Informative References</h3>
<table width="99%" border="0">
<tr><td class="author-text" valign="top"><a name="Google.SGNodeMapper">[Google.SGNodeMapper]</a></td>
<td class="author-text">Fitzpatrick, B., &ldquo;<a href="http://code.google.com/p/google-sgnodemapper/">SocialGraph Node Mapper</a>,&rdquo; 2010.</td></tr>
<tr><td class="author-text" valign="top"><a name="PortableContacts">[PortableContacts]</a></td>
<td class="author-text">Smarr, J., &ldquo;<a href="http://portablecontacts.net/draft-spec.html#response-format">Portable Contacts 1.0 Draft C</a>,&rdquo; August&nbsp;2008.</td></tr>
<tr><td class="author-text" valign="top"><a name="RFC4627">[RFC4627]</a></td>
<td class="author-text">Crockford, D., &ldquo;<a href="http://tools.ietf.org/html/rfc4627">The application/json Media Type for JavaScript Object
            Notation (JSON)</a>,&rdquo; July&nbsp;2006.</td></tr>
</table>

<a name="rfc.authors"></a><br /><hr />
<table summary="layout" cellpadding="0" cellspacing="2" class="TOCbug" align="right"><tr><td class="TOCbug"><a href="#toc">&nbsp;TOC&nbsp;</a></td></tr></table>
<h3>Author's Address</h3>
<table width="99%" border="0" cellpadding="0" cellspacing="0">
<tr><td class="author-text">&nbsp;</td>
<td class="author-text">Echo</td></tr>
</table>
</body></html>
